"use strict";!function(){void 0!==window.DS&&(DS.FirebaseSerializer=DS.JSONSerializer.extend(Ember.Evented,{normalize:function(a,b){return a.eachRelationship(function(c,d){if("hasMany"===d.kind)if("object"!=typeof b[c]||Ember.isArray(b[c])||d.options.embedded===!0){if(Ember.isArray(b[c]))throw new Error('%@ relationship %@(\'%@\') must be a key/value map in Firebase. Example: { "%@": { "%@_id": true } }'.fmt(a.toString(),d.kind,d.type.typeKey,d.key,d.type.typeKey))}else b[c]=Ember.keys(b[c])}),this._super.apply(this,arguments)},extractSingle:function(a,b,c){var d=this.normalize(b,c);return b.eachRelationship(function(b,e){if(!Ember.isNone(c[b])&&e.options.embedded===!0){var f,g,h=d[b],i=[];for(f in h)g=h[f],null!==g&&"object"==typeof g&&(g.id=f),i.push(g);d[b]=Ember.keys(d[b]),a.pushMany(e.type,i)}}),d},extractArray:function(a,b,c){return c.map(function(c){return this.extractSingle(a,b,c)},this)}}),DS.FirebaseAdapter=DS.Adapter.extend(Ember.Evented,{defaultSerializer:"-firebase",init:function(){if(!this.firebase||"object"!=typeof this.firebase)throw new Error("Please set the `firebase` property on the adapter.");this._ref=this.firebase.ref(),this._findAllMapForType={}},generateIdForRecord:function(){return this._ref.push().name()},find:function(a,b,c){var d=!1,e=this._getRef(b,c),f=a.serializerFor(b);return new Ember.RSVP.Promise(function(c,g){e.on("value",function(e){var h=e.val();null!==h&&"object"==typeof h&&(h.id=e.name()),d?null===h&&a.hasRecordForId(b,e.name())?a.getById(b,e.name()).destroyRecord():a.push(b,f.extractSingle(a,b,h)):(d=!0,null===h?Ember.run(null,g):Ember.run(null,c,h))},function(a){d||Ember.run(null,g,a)})},"DS: FirebaseAdapter#find "+b+" to "+e.toString())},findAll:function(a,b){var c=this,d=!1,e=this._getRef(b),f=a.serializerFor(b);return new Ember.RSVP.Promise(function(g,h){var i=function(a){d||(d=!0,Ember.run(null,h,a))};Ember.isNone(c._findAllMapForType[b])&&(c._findAllMapForType[b]=!0,e.on("child_added",function(e){d&&c._handleChildValue(a,b,f,e)},i),e.on("child_changed",function(e){d&&c._handleChildValue(a,b,f,e)},i),e.on("child_removed",function(c){d&&a.hasRecordForId(b,c.name())&&a.deleteRecord(a.getById(b,c.name()))},i)),e.once("value",function(a){var b=[];a.forEach(function(a){var c=a.val();null!==c&&"object"==typeof c&&(c.id=a.name()),b.push(c)}),d=!0,Ember.run(null,g,b)})},"DS: FirebaseAdapter#findAll "+b+" to "+e.toString())},createRecord:function(a,b,c){return this.updateRecord(a,b,c)},updateRecord:function(a,b,c){var d=this,e=c.serialize({includeId:!1}),f=this._getRef(b,c.id);return new Ember.RSVP.Promise(function(b,g){var h=[];c.eachRelationship(function(b,c){if("hasMany"===c.kind){var g=e[b];Ember.isArray(g)&&g.forEach(function(e){var g,h=d._getRelationshipRef(f,b,e),i=Ember.RSVP.defer();a.hasRecordForId(c.type,e)&&(g=a.getById(c.type,e)),c.options.embedded===!0&&g&&g.get("isDirty")===!0?h.update(g.serialize(),function(a){a?("object"==typeof a&&(a.location=h.toString()),Ember.run(null,i.reject,a)):Ember.run(null,i.resolve,a)}):c.options.embedded!==!0&&(g&&g.get("isDirty")===!0||!g)&&h.update(!0,function(a){a?("object"==typeof a&&(a.location=h.toString()),Ember.run(null,i.reject,a)):Ember.run(null,i.resolve,a)})}),delete e[b]}});var i=Ember.RSVP.defer();h.push(i.promise),f.update(e,function(a){a?Ember.run(null,i.reject,a):Ember.run(null,i.resolve)}),Ember.RSVP.allSettled(h).then(function(a){var c=a.filterBy("state","rejected");0===c.get("length")?Ember.run(null,b):Ember.run(null,g,{message:"Some errors were encountered while saving",errors:c.mapBy("reason")})})},"DS: FirebaseAdapter#updateRecord "+b+" to "+f.toString())},deleteRecord:function(a,b,c){var d=this._getRef(b,c.id);return new Ember.RSVP.Promise(function(a,b){d.remove(function(c){c?Ember.run(null,b,c):Ember.run(null,a)})},"DS: FirebaseAdapter#deleteRecord "+b+" to "+d.toString())},pathForType:function(a){var b=Ember.String.camelize(a);return Ember.String.pluralize(b)},_getRef:function(a,b){var c=this._ref;return a&&(c=c.child(this.pathForType(a.typeKey))),b&&(c=c.child(b)),c},_getRelationshipRef:function(a,b,c){return a.child(b).child(c)},_handleChildValue:function(a,b,c,d){var e=d.val();null!==e&&"object"==typeof e&&(e.id=d.name()),a.push(b,c.extractSingle(a,b,e))},_findAllMapForType:void 0}),Ember.onLoad("Ember.Application",function(a){a.initializer({name:"firebase",after:"store",initialize:function(a,b){b.register("serializer:-firebase",DS.FirebaseSerializer)}})}))}();